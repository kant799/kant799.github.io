<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§3Dç´ æçŸ³è†ä½“åœºæ™¯æ¨¡æ‹Ÿå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/TransformControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            overflow: hidden;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            text-align: center;
            border-bottom: 2px solid #00b4ff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, #00b4ff, #ff00cc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            display: flex;
            flex: 1;
            padding: 15px;
            gap: 15px;
            min-height: 0;
        }
        
        #scene-container {
            flex: 1;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            min-height: 0;
        }
        
        #scene {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .panel {
            width: 320px;
            background: rgba(20, 25, 40, 0.85);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            min-height: 0;
        }
        
        .panel-section {
            background: rgba(30, 35, 50, 0.7);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 180, 255, 0.4);
        }
        
        .panel-title h2 {
            font-size: 1.3rem;
            color: #00b4ff;
            margin-left: 10px;
        }
        
        .panel-title i {
            font-size: 1.4rem;
            color: #00b4ff;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        button {
            background: linear-gradient(to right, #0066cc, #00b4ff);
            color: white;
            border: none;
            padding: 12px 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 180, 255, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button.red {
            background: linear-gradient(to right, #cc0000, #ff0066);
        }
        
        button.green {
            background: linear-gradient(to right, #00a86b, #00cc99);
        }
        
        button.purple {
            background: linear-gradient(to right, #6a0dad, #b300ff);
        }
        
        button.blue {
            background: linear-gradient(to right, #006699, #00aaff);
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 8px;
            color: #a0a0ff;
            font-weight: 500;
        }
        
        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider-wrapper input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(100, 100, 150, 0.3);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-wrapper input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00b4ff;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 180, 255, 0.8);
        }
        
        .slider-wrapper .value {
            width: 50px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .history-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .history-info div {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 12px 0;
        }
        
        .color-picker label {
            width: 120px;
            color: #a0a0ff;
        }
        
        .color-picker input {
            width: 60px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: auto;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .instructions h3 {
            color: #00b4ff;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 8px 0;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            font-size: 0.9rem;
            color: #a0a0ff;
            border-top: 1px solid rgba(0, 180, 255, 0.3);
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 180, 255, 0.9);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #00b4ff;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .shadow-quality {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .shadow-quality button {
            padding: 10px 5px;
            font-size: 0.85rem;
        }
        
        .shape-selector {
            margin-top: 15px;
        }
        
        .shape-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 1rem;
            cursor: pointer;
        }
        
        .shape-selector select option {
            background: rgba(30, 35, 50, 0.9);
            padding: 5px;
        }
        
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            .panel {
                width: 100%;
            }
            #scene-container {
                min-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>é«˜çº§3Dç´ æçŸ³è†ä½“åœºæ™¯æ¨¡æ‹Ÿå™¨</h1>
        <p class="subtitle">æ”¯æŒå¤šç§çŸ³è†ä½“å½¢çŠ¶ã€åœ°é¢å˜æ¢ã€ä¸‰è±¡é™æ ‡å¿—æ§åˆ¶å’Œé˜´å½±é”åº¦è°ƒæ•´</p>
    </header>
    
    <div class="container">
        <div id="scene-container">
            <canvas id="scene"></canvas>
        </div>
        
        <div class="panel">
            <div class="panel-section">
                <div class="panel-title">
                    <i>ğŸ“¦</i>
                    <h2>ç‰©ä½“æ“ä½œ</h2>
                </div>
                
                <div class="shape-selector">
                    <select id="shape-selector">
                        <option value="cube">ç«‹æ–¹ä½“</option>
                        <option value="sphere">çƒä½“</option>
                        <option value="cylinder">åœ†æŸ±ä½“</option>
                        <option value="cone">åœ†é”¥ä½“</option>
                        <option value="torus">åœ†ç¯ä½“</option>
                        <option value="dodecahedron">åäºŒé¢ä½“</option>
                        <option value="torusknot">ç¯é¢ç»“</option>
                        <option value="pyramid">é‡‘å­—å¡”</option>
                    </select>
                </div>
                
                <div class="controls">
                    <button id="add-object">
                        <i>+</i> æ·»åŠ çŸ³è†ä½“
                    </button>
                    <button id="remove-object" class="red">
                        <i>âˆ’</i> ç§»é™¤çŸ³è†ä½“
                    </button>
                    <button id="undo" class="purple">
                        <i>â†º</i> æ’¤é”€æ“ä½œ
                    </button>
                    <button id="redo" class="purple">
                        <i>â†»</i> é‡åšæ“ä½œ
                    </button>
                </div>
                
                <div class="controls">
                    <button id="select-ground" class="blue">
                        <i>ğŸŒ</i> é€‰æ‹©åœ°é¢
                    </button>
                    <button id="reset-ground" class="blue">
                        <i>ğŸ”„</i> é‡ç½®åœ°é¢
                    </button>
                </div>
                
                <div class="history-info">
                    <div>
                        <span>å½“å‰çŸ³è†ä½“æ•°é‡:</span>
                        <span id="object-count">0</span>
                    </div>
                    <div>
                        <span>å¯æ’¤é”€æ“ä½œ:</span>
                        <span id="undo-count">0</span>
                    </div>
                    <div>
                        <span>å¯é‡åšæ“ä½œ:</span>
                        <span id="redo-count">0</span>
                    </div>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">
                    <i>ğŸ”§</i>
                    <h2>å˜æ¢æ§åˆ¶</h2>
                </div>
                <div class="controls">
                    <button id="translate-mode" class="green">
                        <i>â‡„</i> ç§»åŠ¨æ¨¡å¼
                    </button>
                    <button id="rotate-mode" class="green">
                        <i>ğŸ”„</i> æ—‹è½¬æ¨¡å¼
                    </button>
                    <button id="scale-mode" class="green">
                        <i>â‡²</i> ç¼©æ”¾æ¨¡å¼
                    </button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">
                    <i>ğŸ‘ï¸</i>
                    <h2>æ˜¾ç¤ºè®¾ç½®</h2>
                </div>
                
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="grid-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="grid-toggle">æ˜¾ç¤ºç½‘æ ¼</label>
                </div>
                
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="ground-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="ground-toggle">æ˜¾ç¤ºåœ°é¢</label>
                </div>
                
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="axes-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="axes-toggle">æ˜¾ç¤ºä¸‰è±¡é™æ ‡å¿—</label>
                </div>
                
                <div class="color-picker">
                    <label>åœºæ™¯èƒŒæ™¯:</label>
                    <input type="color" id="bg-color" value="#f0f0f0">
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">
                    <i>ğŸ’¡</i>
                    <h2>ç¯å…‰è®¾ç½®</h2>
                </div>
                
                <div class="slider-container">
                    <label>ä¸»å…‰æºå¼ºåº¦</label>
                    <div class="slider-wrapper">
                        <input type="range" id="light-intensity" min="0" max="2" step="0.1" value="1">
                        <span class="value" id="light-intensity-value">1.0</span>
                    </div>
                </div>
                
                <div class="slider-container">
                    <label>ç¯å¢ƒå…‰å¼ºåº¦</label>
                    <div class="slider-wrapper">
                        <input type="range" id="ambient-intensity" min="0" max="1" step="0.1" value="0.2">
                        <span class="value" id="ambient-intensity-value">0.2</span>
                    </div>
                </div>
                
                <div class="color-picker">
                    <label>ä¸»å…‰æºé¢œè‰²:</label>
                    <input type="color" id="light-color" value="#ffffff">
                </div>
                
                <div class="slider-container">
                    <label>é˜´å½±é”åˆ©ç¨‹åº¦</label>
                    <div class="slider-wrapper">
                        <input type="range" id="shadow-sharpness" min="1" max="5" step="1" value="3">
                        <span class="value" id="shadow-sharpness-value">ä¸­ç­‰</span>
                    </div>
                </div>
                
                <div class="shadow-quality">
                    <button id="shadow-low" class="blue">ä½è´¨é‡</button>
                    <button id="shadow-medium" class="blue">ä¸­ç­‰</button>
                    <button id="shadow-high" class="blue">é«˜è´¨é‡</button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">
                    <i>ğŸ“·</i>
                    <h2>ç›¸æœºè®¾ç½®</h2>
                </div>
                
                <div class="slider-container">
                    <label>è§†é‡è§’åº¦ (FOV)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="camera-fov" min="20" max="120" step="1" value="60">
                        <span class="value" id="camera-fov-value">60Â°</span>
                    </div>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">
                    <i>ğŸ’¾</i>
                    <h2>åœºæ™¯å¯¼å‡º</h2>
                </div>
                <button id="export-scene" class="purple" style="width:100%">
                    <i>ğŸ“¸</i> ä¿å­˜ä¸ºPNGå›¾ç‰‡
                </button>
            </div>
            
            <div class="instructions">
                <h3>æ“ä½œæŒ‡å—ï¼š</h3>
                <ul>
                    <li>å·¦é”®æ‹–åŠ¨ï¼šæ—‹è½¬ç›¸æœºè§†è§’</li>
                    <li>å³é”®æ‹–åŠ¨ï¼šå¹³ç§»ç›¸æœº</li>
                    <li>æ»šè½®ï¼šç¼©æ”¾è§†å›¾</li>
                    <li>ç‚¹å‡»çŸ³è†ä½“ï¼šé€‰ä¸­ç‰©ä½“è¿›è¡Œå˜æ¢</li>
                    <li>ä½¿ç”¨å˜æ¢æ§ä»¶ï¼šç§»åŠ¨ã€æ—‹è½¬æˆ–ç¼©æ”¾ç‰©ä½“</li>
                    <li>é€‰æ‹©åœ°é¢æŒ‰é’®ï¼šå¯å¯¹åœ°é¢è¿›è¡Œå˜æ¢æ“ä½œ</li>
                    <li>ä½¿ç”¨æ§åˆ¶é¢æ¿ï¼šæ·»åŠ /ç§»é™¤ç‰©ä½“ï¼Œè°ƒæ•´å‚æ•°</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <footer>
        <p>Three.jsé«˜çº§3Dåœºæ™¯æ¨¡æ‹Ÿå™¨ | æ”¯æŒå¤šç§çŸ³è†ä½“å½¢çŠ¶ã€åœ°é¢å˜æ¢å’Œé˜´å½±é”åº¦è°ƒæ•´</p>
    </footer>

    <script>
        // ä¸»è¦Three.jså˜é‡
        let scene, camera, renderer, controls, transformControls;
        let directionalLight, ambientLight, ground, gridHelper, axesHelper;
        let objects = [];
        let selectedObject = null;
        let currentShapeType = 'cube';
        
        // çŸ³è†ä½“æè´¨
        const plasterMaterial = new THREE.MeshStandardMaterial({
            color: 0xffffff,
            roughness: 0.9,
            metalness: 0.0
        });
        
        // é˜´å½±è´¨é‡æ˜ å°„
        const shadowQualityMap = {
            1: { size: 512, name: "ä½è´¨é‡" },
            2: { size: 1024, name: "ä¸­ä½è´¨é‡" },
            3: { size: 2048, name: "ä¸­ç­‰" },
            4: { size: 4096, name: "é«˜è´¨é‡" },
            5: { size: 8192, name: "è¶…é«˜è´¨é‡" }
        };
        
        // å†å²è®°å½•ç®¡ç†
        const historyManager = {
            undoStack: [],
            redoStack: [],
            
            execute: function(command) {
                command.execute();
                this.undoStack.push(command);
                this.redoStack = [];
                updateHistoryUI();
            },
            
            undo: function() {
                if (this.undoStack.length > 0) {
                    const command = this.undoStack.pop();
                    command.undo();
                    this.redoStack.push(command);
                    updateHistoryUI();
                    showNotification("æ’¤é”€æ“ä½œæˆåŠŸ");
                }
            },
            
            redo: function() {
                if (this.redoStack.length > 0) {
                    const command = this.redoStack.pop();
                    command.execute();
                    this.undoStack.push(command);
                    updateHistoryUI();
                    showNotification("é‡åšæ“ä½œæˆåŠŸ");
                }
            }
        };
        
        // å‘½ä»¤ç±»
        class AddObjectCommand {
            constructor(object) {
                this.object = object;
            }
            
            execute() {
                scene.add(this.object);
                objects.push(this.object);
            }
            
            undo() {
                scene.remove(this.object);
                const index = objects.indexOf(this.object);
                if (index !== -1) objects.splice(index, 1);
                if (selectedObject === this.object) {
                    transformControls.detach();
                    selectedObject = null;
                }
            }
        }
        
        class RemoveObjectCommand {
            constructor(object) {
                this.object = object;
            }
            
            execute() {
                scene.remove(this.object);
                const index = objects.indexOf(this.object);
                if (index !== -1) objects.splice(index, 1);
                if (selectedObject === this.object) {
                    transformControls.detach();
                    selectedObject = null;
                }
            }
            
            undo() {
                scene.add(this.object);
                objects.push(this.object);
            }
        }
        
        class TransformCommand {
            constructor(object, oldProps, newProps) {
                this.object = object;
                this.oldProps = oldProps;
                this.newProps = newProps;
            }
            
            execute() {
                this.object.position.copy(this.newProps.position);
                this.object.rotation.copy(this.newProps.rotation);
                this.object.scale.copy(this.newProps.scale);
            }
            
            undo() {
                this.object.position.copy(this.oldProps.position);
                this.object.rotation.copy(this.oldProps.rotation);
                this.object.scale.copy(this.oldProps.scale);
            }
        }
        
        // åˆå§‹åŒ–åœºæ™¯
        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('scene'),
                antialias: true 
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(document.getElementById('scene-container').clientWidth, 
                            document.getElementById('scene-container').clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(60, renderer.domElement.clientWidth / renderer.domElement.clientHeight, 0.1, 1000);
            camera.position.set(5, 5, 10);
            camera.lookAt(0, 0, 0);
            
            // æ·»åŠ è½¨é“æ§åˆ¶
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // æ·»åŠ å˜æ¢æ§åˆ¶
            transformControls = new THREE.TransformControls(camera, renderer.domElement);
            transformControls.addEventListener('dragging-changed', function(event) {
                controls.enabled = !event.value;
            });
            
            // ç›‘å¬å˜æ¢ç»“æŸäº‹ä»¶ä»¥ä¿å­˜çŠ¶æ€
            transformControls.addEventListener('mouseUp', () => {
                if (selectedObject) {
                    const newProps = {
                        position: selectedObject.position.clone(),
                        rotation: selectedObject.rotation.clone(),
                        scale: selectedObject.scale.clone()
                    };
                    
                    const command = new TransformCommand(selectedObject, selectedObject.initialTransform, newProps);
                    historyManager.execute(command);
                    
                    // æ›´æ–°åˆå§‹å˜æ¢çŠ¶æ€
                    selectedObject.initialTransform = newProps;
                }
            });
            
            scene.add(transformControls);
            
            // æ·»åŠ ç¯å…‰
            directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            
            // è®¾ç½®é˜´å½±å‚æ•°
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -10;
            directionalLight.shadow.camera.right = 10;
            directionalLight.shadow.camera.top = 10;
            directionalLight.shadow.camera.bottom = -10;
            
            scene.add(directionalLight);
            
            ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
            scene.add(ambientLight);
            
            // æ·»åŠ åœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x808080,
                roughness: 0.8,
                metalness: 0.2
            });
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -1;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // ä¿å­˜åœ°é¢åˆå§‹å˜æ¢çŠ¶æ€
            ground.initialTransform = {
                position: ground.position.clone(),
                rotation: ground.rotation.clone(),
                scale: ground.scale.clone()
            };
            
            // æ·»åŠ ç½‘æ ¼è¾…åŠ©
            gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);
            
            // æ·»åŠ åæ ‡è½´è¾…åŠ©
            axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            // æ·»åŠ åˆå§‹çŸ³è†ä½“
            addObject('cube');
            addObject('sphere');
            addObject('cylinder');
            
            // äº‹ä»¶ç›‘å¬
            setupEventListeners();
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
            
            // åˆå§‹åŒ–UIçŠ¶æ€
            updateHistoryUI();
        }
        
        // åˆ›å»ºçŸ³è†ä½“å¯¹è±¡
        function createGeometry(type) {
            switch(type) {
                case 'cube':
                    return new THREE.BoxGeometry(1, 1, 1);
                case 'sphere':
                    return new THREE.SphereGeometry(0.7, 32, 32);
                case 'cylinder':
                    return new THREE.CylinderGeometry(0.5, 0.5, 1.5, 32);
                case 'cone':
                    return new THREE.ConeGeometry(0.7, 1.5, 32);
                case 'torus':
                    return new THREE.TorusGeometry(0.7, 0.2, 16, 100);
                case 'dodecahedron':
                    return new THREE.DodecahedronGeometry(0.7);
                case 'torusknot':
                    return new THREE.TorusKnotGeometry(0.7, 0.2, 100, 16);
                case 'pyramid':
                    return new THREE.ConeGeometry(0.8, 1.2, 4);
                default:
                    return new THREE.BoxGeometry(1, 1, 1);
            }
        }
        
        // æ·»åŠ çŸ³è†ä½“
        function addObject(type) {
            const geometry = createGeometry(type);
            const object = new THREE.Mesh(geometry, plasterMaterial);
            
            // è®¾ç½®ä½ç½®å’Œæ—‹è½¬
            object.position.set(
                (Math.random() - 0.5) * 8,
                Math.random() * 3,
                (Math.random() - 0.5) * 8
            );
            
            // éšæœºæ—‹è½¬
            object.rotation.x = Math.random() * Math.PI;
            object.rotation.y = Math.random() * Math.PI;
            object.rotation.z = Math.random() * Math.PI;
            
            object.castShadow = true;
            object.receiveShadow = true;
            
            // ä¿å­˜åˆå§‹å˜æ¢çŠ¶æ€
            object.initialTransform = {
                position: object.position.clone(),
                rotation: object.rotation.clone(),
                scale: object.scale.clone()
            };
            
            const command = new AddObjectCommand(object);
            historyManager.execute(command);
            showNotification(`å·²æ·»åŠ ${getShapeName(type)}`);
        }
        
        // è·å–å½¢çŠ¶åç§°
        function getShapeName(type) {
            const names = {
                'cube': 'ç«‹æ–¹ä½“',
                'sphere': 'çƒä½“',
                'cylinder': 'åœ†æŸ±ä½“',
                'cone': 'åœ†é”¥ä½“',
                'torus': 'åœ†ç¯ä½“',
                'dodecahedron': 'åäºŒé¢ä½“',
                'torusknot': 'ç¯é¢ç»“',
                'pyramid': 'é‡‘å­—å¡”'
            };
            return names[type] || 'çŸ³è†ä½“';
        }
        
        // ç§»é™¤é€‰ä¸­çš„çŸ³è†ä½“
        function removeObject() {
            if (selectedObject && selectedObject !== ground) {
                const command = new RemoveObjectCommand(selectedObject);
                historyManager.execute(command);
                showNotification("çŸ³è†ä½“ç§»é™¤æˆåŠŸ");
            } else if (selectedObject === ground) {
                showNotification("ä¸èƒ½ç§»é™¤åœ°é¢");
            } else {
                showNotification("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ³è†ä½“");
            }
        }
        
        // é‡ç½®åœ°é¢ä½ç½®
        function resetGround() {
            if (ground) {
                const oldProps = {
                    position: ground.position.clone(),
                    rotation: ground.rotation.clone(),
                    scale: ground.scale.clone()
                };
                
                // é‡ç½®åˆ°åˆå§‹ä½ç½®
                ground.position.copy(ground.initialTransform.position);
                ground.rotation.copy(ground.initialTransform.rotation);
                ground.scale.copy(ground.initialTransform.scale);
                
                const newProps = {
                    position: ground.position.clone(),
                    rotation: ground.rotation.clone(),
                    scale: ground.scale.clone()
                };
                
                const command = new TransformCommand(ground, oldProps, newProps);
                historyManager.execute(command);
                
                showNotification("åœ°é¢ä½ç½®å·²é‡ç½®");
            }
        }
        
        // æ›´æ–°é˜´å½±è´¨é‡
        function updateShadowQuality(level) {
            const quality = shadowQualityMap[level];
            if (quality) {
                directionalLight.shadow.mapSize.width = quality.size;
                directionalLight.shadow.mapSize.height = quality.size;
                
                // é‡æ–°åˆ›å»ºé˜´å½±è´´å›¾
                directionalLight.shadow.map?.dispose();
                directionalLight.shadow.map = null;
                
                document.getElementById('shadow-sharpness-value').textContent = quality.name;
                document.getElementById('shadow-sharpness').value = level;
                
                showNotification(`é˜´å½±è´¨é‡è®¾ç½®ä¸º: ${quality.name}`);
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', onWindowResize);
            
            // å½¢çŠ¶é€‰æ‹©
            document.getElementById('shape-selector').addEventListener('change', function() {
                currentShapeType = this.value;
            });
            
            // æ·»åŠ çŸ³è†ä½“æŒ‰é’®
            document.getElementById('add-object').addEventListener('click', () => {
                addObject(currentShapeType);
            });
            
            // ç§»é™¤çŸ³è†ä½“æŒ‰é’®
            document.getElementById('remove-object').addEventListener('click', removeObject);
            
            // æ’¤é”€/é‡åšæŒ‰é’®
            document.getElementById('undo').addEventListener('click', () => historyManager.undo());
            document.getElementById('redo').addEventListener('click', () => historyManager.redo());
            
            // å˜æ¢æ¨¡å¼æŒ‰é’®
            document.getElementById('translate-mode').addEventListener('click', () => {
                transformControls.setMode('translate');
                showNotification("åˆ‡æ¢ä¸ºç§»åŠ¨æ¨¡å¼");
            });
            document.getElementById('rotate-mode').addEventListener('click', () => {
                transformControls.setMode('rotate');
                showNotification("åˆ‡æ¢ä¸ºæ—‹è½¬æ¨¡å¼");
            });
            document.getElementById('scale-mode').addEventListener('click', () => {
                transformControls.setMode('scale');
                showNotification("åˆ‡æ¢ä¸ºç¼©æ”¾æ¨¡å¼");
            });
            
            // ç¯å…‰å¼ºåº¦æ§åˆ¶
            document.getElementById('light-intensity').addEventListener('input', function() {
                const value = parseFloat(this.value);
                directionalLight.intensity = value;
                document.getElementById('light-intensity-value').textContent = value.toFixed(1);
            });
            
            document.getElementById('ambient-intensity').addEventListener('input', function() {
                const value = parseFloat(this.value);
                ambientLight.intensity = value;
                document.getElementById('ambient-intensity-value').textContent = value.toFixed(1);
            });
            
            // ç¯å…‰é¢œè‰²æ§åˆ¶
            document.getElementById('light-color').addEventListener('input', function() {
                directionalLight.color = new THREE.Color(this.value);
            });
            
            // ç›¸æœºFOVæ§åˆ¶
            document.getElementById('camera-fov').addEventListener('input', function() {
                const value = parseInt(this.value);
                camera.fov = value;
                camera.updateProjectionMatrix();
                document.getElementById('camera-fov-value').textContent = value + 'Â°';
            });
            
            // åœºæ™¯å¯¼å‡º
            document.getElementById('export-scene').addEventListener('click', exportScene);
            
            // ç‚¹å‡»é€‰æ‹©å¯¹è±¡
            renderer.domElement.addEventListener('click', onCanvasClick);
            
            // ç½‘æ ¼æ˜¾ç¤ºå¼€å…³
            document.getElementById('grid-toggle').addEventListener('change', function() {
                gridHelper.visible = this.checked;
                showNotification(this.checked ? "ç½‘æ ¼å·²æ˜¾ç¤º" : "ç½‘æ ¼å·²éšè—");
            });
            
            // åœ°é¢æ˜¾ç¤ºå¼€å…³
            document.getElementById('ground-toggle').addEventListener('change', function() {
                ground.visible = this.checked;
                showNotification(this.checked ? "åœ°é¢å·²æ˜¾ç¤º" : "åœ°é¢å·²éšè—");
            });
            
            // åæ ‡è½´æ˜¾ç¤ºå¼€å…³
            document.getElementById('axes-toggle').addEventListener('change', function() {
                axesHelper.visible = this.checked;
                showNotification(this.checked ? "ä¸‰è±¡é™æ ‡å¿—å·²æ˜¾ç¤º" : "ä¸‰è±¡é™æ ‡å¿—å·²éšè—");
            });
            
            // èƒŒæ™¯é¢œè‰²è®¾ç½®
            document.getElementById('bg-color').addEventListener('input', function() {
                scene.background = new THREE.Color(this.value);
            });
            
            // é€‰æ‹©åœ°é¢æŒ‰é’®
            document.getElementById('select-ground').addEventListener('click', function() {
                if (ground) {
                    transformControls.attach(ground);
                    selectedObject = ground;
                    showNotification("å·²é€‰æ‹©åœ°é¢ - å¯ä½¿ç”¨å˜æ¢æ§ä»¶è°ƒæ•´");
                }
            });
            
            // é‡ç½®åœ°é¢æŒ‰é’®
            document.getElementById('reset-ground').addEventListener('click', resetGround);
            
            // é˜´å½±é”åº¦æ§åˆ¶
            document.getElementById('shadow-sharpness').addEventListener('input', function() {
                const level = parseInt(this.value);
                updateShadowQuality(level);
            });
            
            // é˜´å½±è´¨é‡æŒ‰é’®
            document.getElementById('shadow-low').addEventListener('click', () => updateShadowQuality(1));
            document.getElementById('shadow-medium').addEventListener('click', () => updateShadowQuality(3));
            document.getElementById('shadow-high').addEventListener('click', () => updateShadowQuality(5));
        }
        
        // ç”»å¸ƒç‚¹å‡»äº‹ä»¶
        function onCanvasClick(event) {
            const mouse = new THREE.Vector2();
            const rect = renderer.domElement.getBoundingClientRect();
            
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            // æ£€æµ‹æ‰€æœ‰å¯äº¤äº’å¯¹è±¡ï¼ˆçŸ³è†ä½“å’Œåœ°é¢ï¼‰
            const interactableObjects = [...objects];
            if (ground.visible) interactableObjects.push(ground);
            
            const intersects = raycaster.intersectObjects(interactableObjects);
            
            if (intersects.length > 0) {
                const object = intersects[0].object;
                
                if (selectedObject !== object) {
                    transformControls.attach(object);
                    selectedObject = object;
                    
                    if (object === ground) {
                        showNotification("å·²é€‰æ‹©åœ°é¢ - å¯ä½¿ç”¨å˜æ¢æ§ä»¶è°ƒæ•´");
                    } else {
                        showNotification("çŸ³è†ä½“å·²é€‰æ‹©");
                    }
                } else {
                    transformControls.detach();
                    selectedObject = null;
                    showNotification("å·²å–æ¶ˆé€‰æ‹©");
                }
            } else if (selectedObject) {
                transformControls.detach();
                selectedObject = null;
                showNotification("å·²å–æ¶ˆé€‰æ‹©");
            }
        }
        
        // çª—å£å¤§å°è°ƒæ•´å¤„ç†
        function onWindowResize() {
            camera.aspect = renderer.domElement.clientWidth / renderer.domElement.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(renderer.domElement.clientWidth, renderer.domElement.clientHeight);
        }
        
        // æ›´æ–°å†å²è®°å½•UI
        function updateHistoryUI() {
            document.getElementById('object-count').textContent = objects.length;
            document.getElementById('undo-count').textContent = historyManager.undoStack.length;
            document.getElementById('redo-count').textContent = historyManager.redoStack.length;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.opacity = 1;
            
            setTimeout(() => {
                notification.style.opacity = 0;
            }, 2000);
        }
        
        // å¯¼å‡ºåœºæ™¯ä¸ºPNG
        function exportScene() {
            renderer.render(scene, camera);
            
            const link = document.createElement('a');
            link.download = '3d-çŸ³è†ä½“åœºæ™¯.png';
            link.href = renderer.domElement.toDataURL('image/png');
            link.click();
            
            showNotification("åœºæ™¯å·²å¯¼å‡ºä¸ºPNGå›¾ç‰‡");
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>