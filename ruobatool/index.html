<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ®µå­è¯„åˆ†å·¥å…·</title>
    <!-- å¼•å…¥ SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            
            /* è¯„åˆ†é¢œè‰² */
            --score-0: #fee2e2; --text-0: #991b1b;
            --score-1: #f1f5f9; --text-1: #475569;
            --score-2: #e2e8f0; --text-2: #334155;
            --score-3: #dbeafe; --text-3: #1e40af;
            --score-4: #dcfce7; --text-4: #166534;
            --score-5: #fef3c7; --text-5: #92400e;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            width: 100%;
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        h1 { margin: 0; font-size: 1.25rem; color: var(--text-main); font-weight: 700; }
        .subtitle { font-size: 0.8rem; color: var(--text-sub); margin-top: 0.25rem; }

        /* é€šç”¨å®¹å™¨ */
        .container {
            width: 100%;
            max-width: 800px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        #upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }

        .upload-box {
            border: 2px dashed var(--border);
            padding: 3rem 2rem;
            border-radius: 1rem;
            background: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            max-width: 400px;
        }

        .upload-box:active, .upload-box:hover {
            border-color: var(--primary);
            background: #eef2ff;
        }

        .icon-upload {
            width: 48px; height: 48px; fill: var(--text-sub); margin-bottom: 1rem;
        }

        /* è¿›åº¦æ¡ */
        .progress-wrapper {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .progress-track {
            background: #f1f5f9;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-sub);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* å†…å®¹å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center; /* å‚ç›´å±…ä¸­å†…å®¹ */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            position: absolute;
            top: 1rem; left: 1rem; right: 1rem;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-weight: 600;
            background: #f1f5f9;
            color: var(--text-sub);
        }

        .badge.scored {
            background: var(--score-4);
            color: var(--text-4);
            transition: background 0.2s, color 0.2s;
        }

        .content-text {
            font-size: 1.25rem;
            line-height: 1.6;
            margin: 2.5rem 0; /* ç•™å‡º header ç©ºé—´ */
            white-space: pre-wrap;
            font-weight: 500;
            color: var(--text-main);
        }

        /* æŒ‰é’®åŒºåŸŸ */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ç§»åŠ¨ç«¯é»˜è®¤ï¼š3åˆ— */
            gap: 0.75rem;
        }

        .btn {
            border: 1px solid transparent;
            padding: 1rem 0.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn small {
            font-size: 0.7rem;
            font-weight: normal;
            opacity: 0.7;
            margin-top: 4px;
        }

        .btn:active { transform: scale(0.96); }

        /* é¢œè‰²å®šä¹‰ */
        .btn-0 { background: var(--score-0); color: var(--text-0); }
        .btn-1 { background: var(--score-1); color: var(--text-1); }
        .btn-2 { background: var(--score-2); color: var(--text-2); }
        .btn-3 { background: var(--score-3); color: var(--text-3); }
        .btn-4 { background: var(--score-4); color: var(--text-4); }
        .btn-5 { background: var(--score-5); color: var(--text-5); }

        /* é€‰ä¸­çŠ¶æ€ */
        .btn.active {
            box-shadow: 0 0 0 3px white, 0 0 0 5px var(--primary);
            z-index: 10;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-controls {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-nav {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-sub);
            padding: 0.8rem;
            font-size: 0.9rem;
        }
        .btn-nav:active { background: #f8fafc; }

        .btn-export {
            background: var(--primary);
            color: white;
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            margin-top: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }
        .btn-export:active { background: var(--primary-hover); }

        .keyboard-hint {
            text-align: center;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 2rem;
        }
        
        kbd {
            font-family: monospace;
            background: #eee;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (min-width: 640px) {
            .controls-grid {
                grid-template-columns: repeat(6, 1fr); /* æ¡Œé¢ç«¯ï¼š6åˆ— */
            }
            .content-text {
                font-size: 1.5rem;
            }
            .card {
                padding: 2.5rem;
            }
        }
        
        /* è§¦æ‘¸å±éšè—é”®ç›˜æç¤º */
        @media (hover: none) {
            .keyboard-hint { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <h1>æ®µå­è¯„åˆ†å·¥å…·</h1>
    </header>

    <div class="container" id="upload-section">
        <label class="upload-box">
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display: none;">
            <!-- SVG Upload Icon -->
            <svg class="icon-upload" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 14.9861V7.82831L8.82842 9.99989L7.41421 8.58568L12 3.99989L16.5858 8.58568L15.1716 9.99989L13 7.82831V14.9861H11ZM6 18.9861V16.9861H18V18.9861H6Z"/>
            </svg>
            <div style="font-weight: 600; font-size: 1.1rem; color: var(--text-main);">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div>
            <div style="color: var(--text-sub); font-size: 0.9rem; margin-top: 0.5rem;">æ”¯æŒ .xlsx .csv (æ–­ç‚¹ç»­è¯„)</div>
        </label>
    </div>

    <div class="container" id="workspace" style="display: none;">
        
        <!-- è¿›åº¦ -->
        <div class="progress-wrapper">
            <div class="progress-track">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-info">
                <span>è¿›åº¦: <span id="currentIndexDisplay">0</span></span>
                <span>å·²è¯„: <span id="scoredCountDisplay">0</span> / <span id="totalIndexDisplay">0</span></span>
            </div>
        </div>

        <!-- å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <span class="badge" id="itemId">#0</span>
                <span class="badge" id="statusBadge">æœªè¯„åˆ†</span>
            </div>
            <div class="content-text" id="itemContent">...</div>
        </div>

        <!-- è¯„åˆ†æŒ‰é’® -->
        <div class="controls-grid">
            <button class="btn btn-0" onclick="handleRate(0)">0</button>
            <button class="btn btn-1" onclick="handleRate(1)">1</button>
            <button class="btn btn-2" onclick="handleRate(2)">2</button>
            <button class="btn btn-3" onclick="handleRate(3)">3</button>
            <button class="btn btn-4" onclick="handleRate(4)">4</button>
            <button class="btn btn-5" onclick="handleRate(5)">5</button>
        </div>

        <!-- å¯¼èˆª -->
        <div class="nav-controls">
            <button class="btn btn-nav" onclick="prevItem()">ä¸Šä¸€æ¡</button>
            <button class="btn btn-nav" onclick="nextItem()">è·³è¿‡ / ä¸‹ä¸€æ¡</button>
        </div>

        <button class="btn-export" onclick="exportExcel()">å¯¼å‡ºè¯„åˆ†ç»“æœ (.xlsx)</button>

        <div class="keyboard-hint">
            æŒ‰é”®: <kbd>0</kbd>-<kbd>5</kbd> è¯„åˆ† &nbsp; <kbd>â†</kbd> <kbd>â†’</kbd> ç¿»é¡µ
        </div>
    </div>

    <script>
        let rawData = [];
        let currentIndex = 0;
        let originalFileName = "data";
        
        // DOM Elements
        const views = {
            upload: document.getElementById('upload-section'),
            work: document.getElementById('workspace')
        };
        const els = {
            input: document.getElementById('fileInput'),
            content: document.getElementById('itemContent'),
            id: document.getElementById('itemId'),
            status: document.getElementById('statusBadge'),
            pBar: document.getElementById('progressBar'),
            cIdx: document.getElementById('currentIndexDisplay'),
            sCount: document.getElementById('scoredCountDisplay'),
            tCount: document.getElementById('totalIndexDisplay'),
            buttons: document.querySelectorAll('.controls-grid .btn')
        };

        els.input.addEventListener('change', (e) => loadFile(e.target.files[0]));

        function loadFile(file) {
            if(!file) return;
            originalFileName = file.name.split('.')[0];
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                
                initData(json);
            };
            reader.readAsArrayBuffer(file);
        }

        function initData(data) {
            // ç®€å•è¿‡æ»¤ç©ºè¡Œï¼Œå‡è®¾ç»“æ„: [ID, Content, Score(opt)]
            rawData = data.filter(row => row && row.length > 0 && row[1]);
            
            if(rawData.length === 0) return alert('æ•°æ®æ— æ•ˆ');

            // æŸ¥æ‰¾æ–­ç‚¹
            let firstUnscored = -1;
            for(let i=0; i<rawData.length; i++) {
                if(!hasScore(rawData[i]) && firstUnscored === -1) {
                    firstUnscored = i;
                }
            }
            currentIndex = firstUnscored === -1 ? 0 : firstUnscored;

            views.upload.style.display = 'none';
            views.work.style.display = 'flex';
            render();
        }

        function hasScore(row) {
            return row[2] !== undefined && row[2] !== null && String(row[2]).trim() !== '';
        }

        function getScoredCount() {
            return rawData.filter(r => hasScore(r)).length;
        }

        // æ ¸å¿ƒé€»è¾‘ï¼šç‚¹å‡»è¯„åˆ†
        function handleRate(score) {
            if (currentIndex >= rawData.length) return;

            // 1. æ›´æ–°æ•°æ®
            rawData[currentIndex][2] = score;

            // 2. å®æ—¶æ›´æ–°ç•Œé¢çŠ¶æ€ (ä¸ç­‰å¾…è·³è½¬)
            updateButtonStyles(score);
            updateStatusBadge(score);
            updateProgress(); // å®æ—¶æ›´æ–°å·²è¯„åˆ†è®¡æ•°

            // 3. å»¶è¿Ÿè·³è½¬ï¼Œç»™ç”¨æˆ·è§†è§‰ç¡®è®¤
            setTimeout(() => {
                nextItem();
            }, 200);
        }

        function updateButtonStyles(activeScore) {
            els.buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            // æŸ¥æ‰¾å¯¹åº”åˆ†æ•°çš„æŒ‰é’®å¹¶é«˜äº®
            // ç”±äºonclickä¼ å‚æ˜¯æ•°å­—ï¼Œè¿™é‡Œç®€å•åŒ¹é…
            // æ³¨æ„ï¼šquerySelectorAllé¡ºåºå¯¹åº” 0,1,2,3,4,5
            if (activeScore >= 0 && activeScore <= 5) {
                els.buttons[activeScore].classList.add('active');
            }
        }

        function updateStatusBadge(score) {
            if (score !== undefined && score !== null) {
                els.status.textContent = `å·²è¯„åˆ†: ${score}`;
                els.status.className = 'badge scored';
                // åŠ¨æ€è®¾ç½®é¢œè‰²ï¼Œä½¿å…¶ä¸æŒ‰é’®é¢œè‰²ä¸€è‡´
                const colors = [
                    'var(--score-0)', 'var(--score-1)', 'var(--score-2)',
                    'var(--score-3)', 'var(--score-4)', 'var(--score-5)'
                ];
                const textColors = [
                    'var(--text-0)', 'var(--text-1)', 'var(--text-2)',
                    'var(--text-3)', 'var(--text-4)', 'var(--text-5)'
                ];
                els.status.style.background = colors[score];
                els.status.style.color = textColors[score];
            } else {
                els.status.textContent = 'æœªè¯„åˆ†';
                els.status.className = 'badge';
                els.status.style.background = '';
                els.status.style.color = '';
            }
        }

        function updateProgress() {
            const count = getScoredCount();
            const total = rawData.length;
            els.sCount.textContent = count;
            els.tCount.textContent = total;
            els.pBar.style.width = `${(count / total) * 100}%`;
        }

        function render() {
            if(currentIndex >= rawData.length) {
                els.content.textContent = "ğŸ‰ å…¨éƒ¨å®Œæˆï¼\nè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯¼å‡ºã€‚";
                els.id.textContent = "END";
                els.status.style.display = 'none';
                return;
            }

            const row = rawData[currentIndex];
            els.id.textContent = `#${row[0]}`;
            els.content.textContent = row[1];
            els.cIdx.textContent = currentIndex + 1;

            const score = hasScore(row) ? row[2] : null;

            // æ¢å¤çŠ¶æ€
            updateButtonStyles(score);
            updateStatusBadge(score);
            updateProgress();
        }

        function nextItem() {
            if(currentIndex < rawData.length) {
                currentIndex++;
                render();
            }
        }

        function prevItem() {
            if(currentIndex > 0) {
                currentIndex--;
                render();
            }
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rawData);
            ws['!cols'] = [{wch: 10}, {wch: 80}, {wch: 10}];
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${originalFileName}_å·²è¯„åˆ†.xlsx`);
        }

        // é”®ç›˜æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (views.work.style.display === 'none') return;
            if (['ArrowUp','ArrowDown'].includes(e.key)) e.preventDefault();

            if (e.key >= '0' && e.key <= '5') handleRate(parseInt(e.key));
            if (e.key === 'ArrowRight' || e.key === 'Enter') nextItem();
            if (e.key === 'ArrowLeft') prevItem();
        });
    </script>
</body>
</html>